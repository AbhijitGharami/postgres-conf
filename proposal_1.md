# ADMINISTERING LARGE SCALE POSTGRESQL ON SAP MULTICLOUD PLATFORM
SAP MultiCloud Platform is an open platform-as-a-service (PaaS) product that provides core platform and backing services for building and extending cloud applications on multiple cloud infrastructure providers. SAP MultiCloud Platform presently supports AWS, OpenStack, Azure and Google Cloud Platform (GCP). One of the core services provided by SAP MultiCloud Platform is PostgreSQL as a Service. It has more than 5000 PostgreSQL clusters spread across different IaaSes.

Each PostgreSQL cluster consists of 5 VMs, one **primary**, one hot **standby** server and three [**Pgpool**](http://www.pgpool.net/mediawiki/index.php/Main_Page) VMs. The clusters are available in different T-Shirt sizes based on the number of CPU cores, memory and disk sizes. There is **asynchronous replication** between the primary and standby server. The Pgpool VMs continuously monitor the health of the primary server, and in case the primary database fails it trigger the promotion of the standby server to primary. This failover is employed with **STONITH** mechanism. After this the old primary comes back as a new standby server.

PostgreSQL cluster setups have WAL archiving to support point in time recovery **(PITR)**. These WAL files are archived on cloud storage. A base backup is needed to support PITR. In AWS, Azure and GCP the base backup is the **snapshot** of the disk. In Openstack the base backup is taken by copying and compressing the data directory. The service remains available even during the duration base backup is taken. During recovery process the data directory is restored from its base backup and the WAL files are replayed on top of this base backup to recover the data to a desired recovery time objective.

We use [**Bosh**](https://bosh.io/docs/) for managing the deployment and life cycle management of PostgreSQL in a large scale. Bosh is an open source project that offers a tool chain for release engineering, deployment & life-cycle management of large scale distributed services. The lifecycle management operations are triggered through another open source component from SAP MultiCloud platform called [**Service-Fabirk (SF)**](https://github.com/cloudfoundry-incubator/service-fabrik-broker). Some of the operation triggered through SF component are feature update of the cluster, update the cluster to a different T-Shirt size plan, schedule backup for all the clusters.

Every cluster goes through a **bi-weekly rolling update** for introducing new features. When the primary server gets updated as part of this rolling update, the standby server is promoted to primary. The rolling update involves near **zero down time**, and so the service is always available for use. 

A **monitoring agent** runs in every PostgreSQL VM to report its health metrics. These metrics include VM related information like CPU, memory and disk usage, and database related information like availability of the service, replication, number of active connections etc. The monitoring agent collects this information and reports it to [**Riemann**](http://riemann.io/) which is a monitoring component. Riemann processes the metrics and stores it in [**Influxdb**](https://www.influxdata.com/time-series-platform/influxdb/) which is a time series database, and also sends an alerts if some undesired state is reported, like primary server is not available, replication is down, disk size crossed a certain threshold limit. [**Grafana**](https://grafana.com/), another monitoring component, shows all these time series data from Influxdb in a dashboard.
